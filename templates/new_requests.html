{% extends 'base.html' %}

{% block style %}
<link rel="stylesheet" href="{{ url_for('static', filename='assets/css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='assets/css/new.css') }}">
{% endblock %}

{% block body %}

{% include 'auth.html' %}

{% endblock %}

{% block main %}
<main>
    <div class="container">
        <h3 class="section-title">Requests</h3>
        <div class="intro offers">
            {% for user in pending_users %}
            <section class="offer">
                <header>
                    <h3 class="title">Name: {{user.name}} </h3>
                    <br>
                    <span class="subtitle">Email Address: {{user.email}} </span>
                    <br>
                    <span class="subtitle">Plan: {{ pending[loop.index - 1].plan }} </span>
                    <br>
                </header>
<button id="{{pending[loop.index-1].id}}" class="subscribe" data-reference="{{pending[loop.index-1].reference}}">Verify
    Payment<i class="fas fa-chevron-right"></i></button>
<button id="{{pending[loop.index-1].id}}" class="subscribed" data-reference="{{pending[loop.index-1].reference}}"><i
        id='spin'></i>Approve<i class="fas fa-chevron-right"></i></button>
                <a href="mailto:{{user.email}}"><button class="mail">Send a mail<i class="fas fa-chevron-right"></i></button></a>
            </section>
            {% endfor %}
        </div>
    </div>

</main>
{% endblock %}
{% block script %}
<script src="{{ url_for('static', filename='assets/js/dashboard.js') }}"></script>
<script>
    var btns = $('.subscribe');

    var approve_btns = $('.subscribed');

    approve_btns.click(function () {
        var spin = document.querySelector('#spin')
        var btn = this;        
        btn.disabled = true;
        spin.className = 'fa fa-spinner fa-spin';
        $.getJSON(window.location.protocol + '//' + document.domain + ':' + window.location.port + '/approve', {            
            id: this.id
        }, function (data) {
            if (data.response === 'success') {
                btn.innerText = 'Approved';
                btn.className = 'subscribe subscribed';
                btn.disabled = 'true';
            } else if (data.response === 'Not Found') {
                alert('Reference not valid')
                spin.className = 'subscribed';
            } else {
                alert('an error occured please try again')
                spin.className = 'subscribed';
            }
        })
    })
    btns.click(function () {        
        var btn = this;
        let ref = this.dataset['reference']
        if (ref === 'bankPay'){
            alert('Bank Payment');
            return;
        }
        $.ajax({
            url: 'https://api.paystack.co/transaction/verify/' + ref,
            type: 'GET',
            dataType: 'json',
            success: function () {
                alert('Successful!');
            },
            error: function () {
                alert('An Error occured, please try again!');
            },
            beforeSend: setHeader
        }).done(function (data) {
            console.log(data)
            if (data.message === 'Verification successful') {
                alert('Payment Verified')
                btn.innerText = 'Verified';
                btn.className = 'subscribe subscribed';
                btn.disabled = 'true';
            } else {
                alert('An Error Occured')
            }
        });

        function setHeader(xhr) {
            xhr.setRequestHeader("Authorization", "Bearer sk_test_51c93b8f100a9f323aeb4a3fb96590d4df47ecac");
        }
    })
</script>
{% endblock %}